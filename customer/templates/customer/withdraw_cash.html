{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Withdraw Cash</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Reuse shared styles -->
  <link rel="stylesheet" href="{% static 'css/portfolio.css' %}" />

  <style>
    /* Page-specific tweaks */
    .withdraw-card{
      max-width: 560px;
      margin: 24px auto;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,.15);
      padding: 24px;
    }
    .withdraw-card h2{ margin: 0 0 16px; }

    .field{ margin: 16px 0; }
    .field label{ display:block; font-weight:600; margin-bottom:6px; }
    .input{
      width:100%;
      padding:12px 14px;
      border:1px solid #cbd5e1;
      border-radius:8px;
      background: var(--surface);
      outline:none;
      transition: box-shadow .15s, border-color .15s;
      font-size:1rem;
      box-sizing:border-box;
    }
    .input:focus{ border-color: var(--primary); box-shadow:0 0 0 3px var(--ring); }

    .btn{
      width:100%;
      padding:12px 16px;
      background: var(--primary);
      color:#fff;
      border:0;
      border-radius:8px;
      font-weight:700;
      cursor:pointer;
      transition: background .15s, opacity .15s, transform .02s;
      margin-top: 8px;
    }
    .btn:hover{ background: var(--primary-600); }
    .btn:active{ transform: translateY(1px); }
    .btn[disabled]{ opacity:.5; cursor:not-allowed; }

    .meta{ color: var(--muted); margin-top: 8px; }
    .strong{ font-weight:700; color:#0f172a; }

    .warn, .ok{
      margin-top:12px; padding:10px 12px; border-radius:8px; display:none;
    }
    .warn{ color:#b91c1c; background:#fee2e2; border:1px solid #fecaca; }
    .ok{ color:#065f46; background:#ecfdf5; border:1px solid #a7f3d0; }
  </style>
</head>

<body class="portfolio">
  <!-- Same header as other pages -->
  <header class="site-header">
    <div class="brand">
      <img src="{% static 'images/logo_investr.io.png' %}" alt="InvestR.io Logo" class="site-logo" />
      <span class="brand-text">Withdraw Cash</span>
    </div>
    <nav class="nav">
      <a href="{% url 'portfolio' %}">Portfolio</a>
      <a href="{% url 'buy_stock' %}">Buy Stock</a>
      <a href="{% url 'sell_stock' %}">Sell Stock</a>
      <a href="{% url 'deposit_cash' %}">Deposit Cash</a>
      <a href="{% url 'withdraw_cash' %}" class="active">Withdraw Cash</a>
      <a href="{% url 'sign_out' %}">Logout</a>
    </nav>
  </header>

  <main class="wrap">
        <section class="withdraw-card">
            <h2>Withdraw Cash</h2>

            <form id="cashForm">
                {% csrf_token %}
                <input type="hidden" name="type" value="WITHDRAW">
                
                <div class="field">
                    <label for="amount">Enter Amount to Withdraw ($)</label>
                    <input id="amount" name="amount" class="input" type="number" min="0.01" step="0.01" placeholder="e.g., 200.00" required />
                </div>
                
                <button id="withdrawBtn" class="btn" disabled>Withdraw</button>
            </form>

            <div class="meta">
                Cash Available: <span id="cashAvail" class="strong">
                    {% if account %}${{ account.cash_balance|floatformat:2 }}{% else %}$0.00{% endif %}
                </span>
            </div>

            <div id="warn" class="warn"></div>
            <div id="ok" class="ok"></div>
        </section>
    </main>

    <script>
        const amountInput = document.getElementById('amount');
        const withdrawBtn = document.getElementById('withdrawBtn');
        const cashAvailEl = document.getElementById('cashAvail');
        const warnEl = document.getElementById('warn');
        const okEl = document.getElementById('ok');
        const cashForm = document.getElementById('cashForm');

        const initialCashString = cashAvailEl.textContent.replace('$', '').replace(/,/g, '');
        let currentCash = parseFloat(initialCashString) || 0;
      
        const fmt = n => '$' + (Number(n).toFixed(2)).replace(/\B(?=(\d{3})+(?!\d))/g, ",");

        function updateCashDisplay() {
            cashAvailEl.textContent = fmt(currentCash);
        }

        function validate() {
            const n = parseFloat(amountInput.value);
            const valid = n > 0 && n <= currentCash;
            
            withdrawBtn.disabled = !valid;
            
            warnEl.style.display = 'none';
            okEl.style.display = 'none';

            if (amountInput.value && n > currentCash) {
                warnEl.textContent = 'Insufficient funds for this withdrawal.';
                warnEl.style.display = 'block';
            } else if (amountInput.value && n <= 0) {
                warnEl.textContent = 'Amount must be greater than $0.00.';
                warnEl.style.display = 'block';
            }
        }

        amountInput.addEventListener('input', validate);

        cashForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const amount = parseFloat(amountInput.value);
            if (!(amount > 0 && amount <= currentCash)) { validate(); return; }

            withdrawBtn.disabled = true;
            withdrawBtn.textContent = 'Processing...';
            warnEl.style.display = 'none';
            okEl.textContent = 'Processing withdrawal...';
            okEl.style.display = 'block';

            fetch('/api/v1/accounts/withdraw/', {
                method: 'POST',
                body: new FormData(cashForm),
            })
            .then(response => response.json().then(data => ({ status: response.status, body: data })))
            .then(({ status, body }) => {
                if (status === 200) {
                    currentCash = parseFloat(body.new_cash);
                    updateCashDisplay();
                    okEl.textContent = body.message + `. New Balance: ${fmt(currentCash)}`;
                    okEl.style.display = 'block';
                    warnEl.style.display = 'none';
                    amountInput.value = ''; 
                } else {
                    warnEl.textContent = body.error || `Transaction failed with status ${status}.`;
                    warnEl.style.display = 'block';
                    okEl.style.display = 'none';
                }
            })
            .catch(error => {
                warnEl.textContent = 'A network error occurred. Please try again.';
                warnEl.style.display = 'block';
                okEl.style.display = 'none';
                console.error('Error:', error);
            })
            .finally(() => {
                withdrawBtn.textContent = 'Withdraw';
                validate(); 
            });
        });

        updateCashDisplay();
        validate();
    </script>
</body>
</html>